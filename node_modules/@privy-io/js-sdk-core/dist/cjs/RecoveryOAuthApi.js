"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@privy-io/public-api"),t=require("./Error.js"),r=require("./pkce.js");require("jose");exports.default=class{_privyInternal;_storage;_crypto;constructor(e,t,r){this._privyInternal=e,this._storage=t,this._crypto=r}async generateURL(t){const i=r.createCodeVerifier(),o=r.createStateCode(),a=await r.deriveCodeChallengeFromCodeVerifier({codeVerifier:i,digest:this._crypto?.digest});return await Promise.all([this._storage.put(r.CODE_VERIFIER_KEY,i),this._storage.put(r.STATE_CODE_KEY,o)]),this._privyInternal.fetch(e.RecoveryOAuthInit,{body:{redirect_to:t,code_challenge:a,state_code:o}})}async authorize(i,o){const[a,s]=await Promise.all([this._storage.get(r.CODE_VERIFIER_KEY),this._storage.get(r.STATE_CODE_KEY)]);if(s!==o)throw this._privyInternal.createAnalyticsEvent("possible_phishing_attempt",{flow:"recovery_oauth",storedStateCode:s??"",returnedStateCode:o??""}),new t.PrivyClientError({code:"pkce_state_code_mismatch",error:"Unexpected auth flow. This may be a phishing attempt."});const _=await this._privyInternal.fetch(e.RecoveryOAuthAuthenticate,{body:{authorization_code:i,state_code:s,code_verifier:a}});return await Promise.all([this._storage.del(r.CODE_VERIFIER_KEY),this._storage.del(r.STATE_CODE_KEY)]),_}};
