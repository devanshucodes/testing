import{jsx as o}from"react/jsx-runtime";import{useState as t,useMemo as n,useEffect as e}from"react";import{formatEther as r}from"viem";import{useAppConfig as i}from"../../configuration/context.mjs";import{PrivyProviderRpcError as s,ProviderRpcError as a}from"../../connectors/errors.mjs";import{sendTransaction as c,formatReceipt as m}from"../../embedded-wallets/rpc/index.mjs";import{usePrivyInternal as p}from"../../hooks/internal-context.mjs";import{usePrivyModal as l}from"../../hooks/modal-context.mjs";import{usePrivyContext as d}from"../../hooks/privy-context.mjs";import{useGetTokenPrice as u}from"../../hooks/useGetTokenPrice.mjs";import{getErc20TokenInfo as j}from"../../lib/erc20/actions/getErc20TokenInfo.mjs";import{formatErc20TokenAmount as h}from"../../lib/erc20/formatErc20TokenAmount.mjs";import{getNativeCurrencyFromWei as f,getDollarsFromWei as g}from"../../lib/ethers.mjs";import{getJsonRpcProvider as T}from"../../utils/index.mjs";import{ErrorScreenView as b}from"../ErrorScreen.mjs";import{ModalScreen as y}from"../index.mjs";import{SendTransactionScreenView as I}from"./SendTransactionScreenView.mjs";import{TransactionErrorView as C}from"./TransactionErrorView.mjs";import{TransactionReceiptView as E}from"./TransactionReceiptView.mjs";import{getStaticTransactionMetadata as w}from"./getStaticTransactionMetadata.mjs";import{usePrepareTransaction as S}from"./usePrepareTransaction.mjs";import{n as x}from"../../errors-9ucGZPEs.mjs";import{i as v}from"../../ethers-Cz-frLvN.mjs";import"../../config.mjs";import"../../configuration/defaultClientConfig.mjs";import"../../constants.mjs";import"../../configuration/login-methods.mjs";import"../../configuration/wallets.mjs";import"../../connectors/chains/index.mjs";import"../../connectors/chains/arbitrum.mjs";import"../../connectors/chains/arbitrumSepolia.mjs";import"../../connectors/chains/avalanche.mjs";import"../../connectors/chains/avalancheFuji.mjs";import"../../connectors/chains/base.mjs";import"../../connectors/chains/baseSepolia.mjs";import"../../connectors/chains/berachainArtio.mjs";import"../../connectors/chains/celo.mjs";import"../../connectors/chains/celoAlfajores.mjs";import"../../connectors/chains/filecoin.mjs";import"../../connectors/chains/filecoinCalibration.mjs";import"../../connectors/chains/garnetHolesky.mjs";import"../../connectors/chains/holesky.mjs";import"../../connectors/chains/linea.mjs";import"../../connectors/chains/lineaTestnet.mjs";import"../../connectors/chains/lukso.mjs";import"../../connectors/chains/mainnet.mjs";import"../../connectors/chains/optimism.mjs";import"../../connectors/chains/optimismSepolia.mjs";import"../../connectors/chains/polygon.mjs";import"../../connectors/chains/polygonAmoy.mjs";import"../../connectors/chains/redstone.mjs";import"../../connectors/chains/sepolia.mjs";import"../../connectors/chains/zora.mjs";import"../../connectors/chains/zoraSepolia.mjs";import"../../connectors/chains/zoraTestnet.mjs";import"../../connectors/chains/utils.mjs";import"../../lib/solana/index.mjs";import"../../theme.mjs";import"tinycolor2";import"../../lib/cybr53.mjs";import"@ethersproject/logger";import"../../errors.mjs";import"ofetch";import"@ethersproject/providers";import"@ethersproject/bignumber";import"../../hooks/index.mjs";import"../../components/PrefetchedImage.mjs";import"../../hooks/useGetSolPrice.mjs";import"../../connectors/get-legacy-injected-providers.mjs";import"../../connectors/is-wallet-installed.mjs";import"@ethersproject/units";import"@heroicons/react/24/outline/ExclamationTriangleIcon";import"@heroicons/react/24/outline/PhoneIcon";import"styled-components";import"../../components/Button.mjs";import"../../components/Loader.mjs";import"../../components/CircleBorder.mjs";import"../../components/ModalHeader.mjs";import"@heroicons/react/24/outline/ArrowLeftIcon";import"@heroicons/react/24/outline/ArrowRightIcon";import"@heroicons/react/24/outline/QuestionMarkCircleIcon";import"@heroicons/react/24/outline/XMarkIcon";import"../../components/layout/StackedContainer.mjs";import"../../embedded-wallets/errors.mjs";import"../../embedded-wallets/types.mjs";import"../../hooks/captcha-context.mjs";import"../../svg/lock-closed.mjs";import"@heroicons/react/24/outline";import"../../components/ModalFooter.mjs";import"../../svg/protected-by-privy.mjs";import"../../components/ui/layout/Row.mjs";import"../../components/ui/typography/ErrorMessage.mjs";import"../../components/ui/typography/LabelSm.mjs";import"../../components/ui/typography/Subtitle.mjs";import"../../components/ui/typography/Title.mjs";import"../../components/ui/typography/Value.mjs";import"../../components/ui/animation/LoadingSkeleton.mjs";import"../../components/ui/wallet/Address.mjs";import"@heroicons/react/24/outline/CheckIcon";import"@heroicons/react/24/outline/Square2StackIcon";import"../../components/ui/wallet/WalletInfoCard.mjs";import"../../components/ui/chips/Chip.mjs";import"../../components/ui/layout/Column.mjs";import"../../components/ui/typography/LabelXs.mjs";import"../../components/ui/wallet/shared.mjs";import"../LandingScreen/styles.mjs";import"./TransactionDetail.mjs";import"@ethersproject/address";import"./useTransactionDetails.mjs";import"@heroicons/react/24/outline/ClipboardDocumentCheckIcon";import"@heroicons/react/24/outline/ClipboardDocumentIcon";import"@heroicons/react/24/outline/ExclamationCircleIcon";import"./EthersTransactionError.mjs";import"../../components/Layouts.mjs";import"../../components/ScreenHeader.mjs";import"../../components/embedded-wallets/TransactionDetails.mjs";import"../../components/embedded-wallets/DisplayInfoItem.mjs";import"../../components/embedded-wallets/PriceDisplay.mjs";import"../../lib/solana/transaction.mjs";import"../../utils/buffer/readBigInt64LE.mjs";import"../../components/embedded-wallets/TransactionTotal.mjs";import"../../components/primitives/Accordion/index.mjs";import"@heroicons/react/24/outline/ChevronDownIcon";import"../../components/primitives/Accordion/AccordionContext.mjs";import"../../components/embedded-wallets/WalletLink.mjs";import"../../lib/deployAccount/actions/abis/deployAccount.mjs";import"../../lib/erc20/actions/abis/approve.mjs";import"../../lib/erc20/actions/abis/transfer.mjs";import"../../lib/erc721/actions/abis/mint.mjs";import"../../lib/erc721/actions/abis/safeTransferFrom.mjs";import"../../lib/erc721/actions/abis/setApprovalForAll.mjs";import"../../lib/erc721/actions/abis/transferFrom.mjs";import"../../lib/erc1155/actions/abis/safeBatchTransferFrom.mjs";import"../../lib/erc1155/actions/abis/safeTransferFrom.mjs";import"../../index-B3QfI7v9.mjs";import"@ethersproject/abstract-signer";import"@ethersproject/contracts";import"@ethersproject/transactions";import"fetch-retry";let k=new s(new a("There was an issue preparing your transaction",x.E32603_DEFAULT_INTERNAL_ERROR.eipCode)),A=(o,t)=>o?.sendTransaction?"transactionRequest"in o.sendTransaction?o.sendTransaction.transactionRequest:o.sendTransaction.transactionRequests[t]:void 0;const D=()=>{let D,{data:R,onUserCloseViaDialogOrKeybindRef:F,setModalData:O,navigate:L}=l(),{rpcConfig:P,chains:N,closePrivyModal:q,walletProxy:M}=p(),{getAccessToken:_,user:B}=d(),G=i(),[H,V]=t(0),U=(o=>o?.sendTransaction?"transactionRequest"in o.sendTransaction?0:o.sendTransaction.transactionRequests.length-1:0)(R),[W,z]=t(A(R,H)),[Q,X]=t(null),[$,J]=t(),[K,Y]=t(!1),[Z,oo]=t(null),[to,no]=t(null);if(!W||!R?.sendTransaction||!R?.sendTransaction.transactingWallet)/*#__PURE__*/return o(b,{error:Error("Invalid transaction request"),onClick:()=>{R?.sendTransaction?.onFailure(k),q({shouldCallAuthOnSuccess:!1})}});let{entropyId:eo,entropyIdVerifier:ro,transactingWallet:io}=R.sendTransaction,so=n((()=>N.find((o=>Number(o.id)===Number(W.chainId)))),[W.chainId]),ao=so?.nativeCurrency.symbol??"ETH",co=n((()=>w(W.data,!!G.embeddedWallets.extendedCalldataDecoding)),[W.data]),{action:mo,isErc20Ish:po,isNFTIsh:lo}=co;e((()=>{W.to&&so&&po&&j({address:W.to,chain:so,rpcConfig:G.rpcConfig,privyAppId:G.id}).then(X).catch(console.error)}),[W.to,so]);let{tokenPrice:uo,isTokenPriceLoading:jo}=u(W.chainId),ho=n((()=>T(Number(W.chainId),N,P,{appId:G.id})),[W.chainId,P]),fo=S(W,io,ho);e((()=>{z(A(R,H))}),[H]),e((()=>{R.sendTransaction?.getIsSponsored?R.sendTransaction.getIsSponsored().then(J).catch(console.error):J(!1)}),[R.sendTransaction.getIsSponsored]);let go=()=>{if(!K)return Z?R?.sendTransaction?.onSuccess(Z.response):to||fo?.errors[0]?R?.sendTransaction?.onFailure(to??fo?.errors[0]??k):R?.sendTransaction?.onFailure(new s(new a("The user rejected the request",x.E4001_USER_REJECTED_REQUEST.eipCode))),q({shouldCallAuthOnSuccess:!1})};F.current=go;let To=!!(R.funding&&R.funding.supportedOptions.length>0),bo="fiat-currency"===G.embeddedWallets.priceDisplay.primary,yo=v(fo?.tx.value??0).add(v(fo?.totalGasEstimate?.toBigInt()??0)).toHexString(),Io=f(yo,ao),Co=bo&&uo?g(yo,uo):void 0,Eo=f(fo?.totalGasEstimate?.toString()??0,ao),wo=bo&&uo?g(fo?.totalGasEstimate?.toString()??0,uo):void 0,So=f(fo?.balance?.toString()??0,ao,void 0,!0),xo=bo&&uo?g(fo?.balance?.toString()??0,uo):void 0,vo=R.sendTransaction?.uiOptions?.transactionInfo?.title;vo||(vo="approve"===mo?po?"Confirm address":"Confirm action":`Approve ${mo}`);let ko=R.sendTransaction?.uiOptions?.description||`${G.name} wants your permission to approve the following transaction.`,Ao=R.sendTransaction?.uiOptions?.transactionInfo?.contractInfo?.imgUrl?/*#__PURE__*/o("img",{src:R.sendTransaction.uiOptions.transactionInfo.contractInfo.imgUrl,alt:R.sendTransaction.uiOptions.transactionInfo.contractInfo.imgAltText}):null,Do=!(!fo||fo.errors[0]||fo.hasFunds||!1!==$),Ro=Do&&To,Fo=Ro?"Add funds":R.sendTransaction?.uiOptions?.buttonText||(H<U?"Continue":"Approve");if(Z?.receipt)/*#__PURE__*/return o(E,{txn:fo?.tx??W,onClose:go,receipt:Z.receipt,transactionInfo:R.sendTransaction?.uiOptions.transactionInfo,tokenPrice:uo,tokenSymbol:ao,l1GasEstimate:fo?.l1ExecutionFeeEstimate?.toString(),receiptHeader:R.sendTransaction?.uiOptions.successHeader,receiptDescription:R.sendTransaction?.uiOptions.successDescription});if(to)/*#__PURE__*/return o(C,{transactionError:to,network:"ethereum",chainId:fo?.tx.chainId??W.chainId,onClose:go,onRetry:({resetNonce:o})=>{no(null);let t={...fo?.tx??W};o&&(t.nonce=void 0),z(t)}});let Oo=0!==U&&"number"==typeof H&&0!==H?()=>{V(H-1)}:void 0;return"amount"in co&&co.amount&&(co.isNFTIsh?D=co.amount.toString():Q&&(D=h({amount:co.amount,decimals:Q.decimals}))),/*#__PURE__*/o(I,{transactionIndex:H,onBack:Oo,maxIndex:U,disabled:Do&&!To,isSubmitting:K,submitError:to,isPreparing:!fo,isTokenPriceLoading:jo,isTokenContractInfoLoading:!lo&&!Q,prepareError:fo?.errors[0],symbol:Q?.symbol,chain:so,img:Ao,title:vo,subtitle:ko,total:W.value?Co??Io:void 0,txValue:W.value,fee:wo??Eo,isSponsored:$,from:io?.address??"",to:W.to,network:G.chains.find((o=>o.id===W.chainId))?.name??"",transactionDetails:{...co,formattedAmount:D},cta:Fo,missingFunds:Do,action:mo,balance:xo??So,onClose:go,onClick:Ro?async()=>{if(!io)return;if(!To)throw Error("Funding wallet is not enabled");let o=y.FUNDING_METHOD_SELECTION_SCREEN;O({...R,funding:{...R.funding,methodScreen:o,chainType:"ethereum",amount:r(BigInt(fo?.tx.value??0)+BigInt(fo?.totalGasEstimate?.toString()??0)),chain:so}}),L(o)}:async()=>{if(H<U)V(H+1);else{Y(!0);try{let o=await _();if(K||!o||!io||!M||!B)return;let t=R?.sendTransaction?.onConfirm?await R.sendTransaction.onConfirm().then((o=>ho.getTransaction(o))):await c({accessToken:o,transactingWallet:io,entropyId:eo,entropyIdVerifier:ro,walletProxy:M,transactionRequest:fo?.tx??W,provider:ho,requesterAppId:R.sendTransaction?.requesterAppId}),n=await t.wait();oo({receipt:m(n),response:t})}catch(o){console.warn({transaction:fo?.tx??W,error:o}),no(o)}finally{Y(!1)}}}})};export{D as SendTransactionScreen};
