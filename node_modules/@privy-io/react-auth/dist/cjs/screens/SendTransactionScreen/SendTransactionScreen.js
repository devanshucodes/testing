"use strict";var e=require("react/jsx-runtime"),r=require("react"),n=require("viem"),i=require("../../configuration/context.js"),o=require("../../connectors/errors.js"),s=require("../../embedded-wallets/rpc/index.js"),t=require("../../hooks/internal-context.js"),a=require("../../hooks/modal-context.js"),c=require("../../hooks/privy-context.js"),u=require("../../hooks/useGetTokenPrice.js"),l=require("../../lib/erc20/actions/getErc20TokenInfo.js"),d=require("../../lib/erc20/formatErc20TokenAmount.js"),p=require("../../lib/ethers.js"),q=require("../../utils/index.js"),m=require("../ErrorScreen.js"),j=require("../index.js"),h=require("./SendTransactionScreenView.js"),g=require("./TransactionErrorView.js"),f=require("./TransactionReceiptView.js"),T=require("./getStaticTransactionMetadata.js"),b=require("./usePrepareTransaction.js"),y=require("../../errors-3fxlG6WB.js"),I=require("../../ethers-De6TACnn.js");require("../../config.js"),require("../../configuration/defaultClientConfig.js"),require("../../constants.js"),require("../../configuration/login-methods.js"),require("../../configuration/wallets.js"),require("../../connectors/chains/index.js"),require("../../connectors/chains/arbitrum.js"),require("../../connectors/chains/arbitrumSepolia.js"),require("../../connectors/chains/avalanche.js"),require("../../connectors/chains/avalancheFuji.js"),require("../../connectors/chains/base.js"),require("../../connectors/chains/baseSepolia.js"),require("../../connectors/chains/berachainArtio.js"),require("../../connectors/chains/celo.js"),require("../../connectors/chains/celoAlfajores.js"),require("../../connectors/chains/filecoin.js"),require("../../connectors/chains/filecoinCalibration.js"),require("../../connectors/chains/garnetHolesky.js"),require("../../connectors/chains/holesky.js"),require("../../connectors/chains/linea.js"),require("../../connectors/chains/lineaTestnet.js"),require("../../connectors/chains/lukso.js"),require("../../connectors/chains/mainnet.js"),require("../../connectors/chains/optimism.js"),require("../../connectors/chains/optimismSepolia.js"),require("../../connectors/chains/polygon.js"),require("../../connectors/chains/polygonAmoy.js"),require("../../connectors/chains/redstone.js"),require("../../connectors/chains/sepolia.js"),require("../../connectors/chains/zora.js"),require("../../connectors/chains/zoraSepolia.js"),require("../../connectors/chains/zoraTestnet.js"),require("../../connectors/chains/utils.js"),require("../../lib/solana/index.js"),require("../../theme.js"),require("tinycolor2"),require("../../lib/cybr53.js"),require("@ethersproject/logger"),require("../../errors.js"),require("ofetch"),require("@ethersproject/providers"),require("@ethersproject/bignumber"),require("../../hooks/index.js"),require("../../components/PrefetchedImage.js"),require("../../hooks/useGetSolPrice.js"),require("../../connectors/get-legacy-injected-providers.js"),require("../../connectors/is-wallet-installed.js"),require("@ethersproject/units"),require("@heroicons/react/24/outline/ExclamationTriangleIcon"),require("@heroicons/react/24/outline/PhoneIcon"),require("styled-components"),require("../../components/Button.js"),require("../../components/Loader.js"),require("../../components/CircleBorder.js"),require("../../components/ModalHeader.js"),require("@heroicons/react/24/outline/ArrowLeftIcon"),require("@heroicons/react/24/outline/ArrowRightIcon"),require("@heroicons/react/24/outline/QuestionMarkCircleIcon"),require("@heroicons/react/24/outline/XMarkIcon"),require("../../components/layout/StackedContainer.js"),require("../../embedded-wallets/errors.js"),require("../../embedded-wallets/types.js"),require("../../hooks/captcha-context.js"),require("../../svg/lock-closed.js"),require("@heroicons/react/24/outline"),require("../../components/ModalFooter.js"),require("../../svg/protected-by-privy.js"),require("../../components/ui/layout/Row.js"),require("../../components/ui/typography/ErrorMessage.js"),require("../../components/ui/typography/LabelSm.js"),require("../../components/ui/typography/Subtitle.js"),require("../../components/ui/typography/Title.js"),require("../../components/ui/typography/Value.js"),require("../../components/ui/animation/LoadingSkeleton.js"),require("../../components/ui/wallet/Address.js"),require("@heroicons/react/24/outline/CheckIcon"),require("@heroicons/react/24/outline/Square2StackIcon"),require("../../components/ui/wallet/WalletInfoCard.js"),require("../../components/ui/chips/Chip.js"),require("../../components/ui/layout/Column.js"),require("../../components/ui/typography/LabelXs.js"),require("../../components/ui/wallet/shared.js"),require("../LandingScreen/styles.js"),require("./TransactionDetail.js"),require("@ethersproject/address"),require("./useTransactionDetails.js"),require("@heroicons/react/24/outline/ClipboardDocumentCheckIcon"),require("@heroicons/react/24/outline/ClipboardDocumentIcon"),require("@heroicons/react/24/outline/ExclamationCircleIcon"),require("./EthersTransactionError.js"),require("../../components/Layouts.js"),require("../../components/ScreenHeader.js"),require("../../components/embedded-wallets/TransactionDetails.js"),require("../../components/embedded-wallets/DisplayInfoItem.js"),require("../../components/embedded-wallets/PriceDisplay.js"),require("../../lib/solana/transaction.js"),require("../../utils/buffer/readBigInt64LE.js"),require("../../components/embedded-wallets/TransactionTotal.js"),require("../../components/primitives/Accordion/index.js"),require("@heroicons/react/24/outline/ChevronDownIcon"),require("../../components/primitives/Accordion/AccordionContext.js"),require("../../components/embedded-wallets/WalletLink.js"),require("../../lib/deployAccount/actions/abis/deployAccount.js"),require("../../lib/erc20/actions/abis/approve.js"),require("../../lib/erc20/actions/abis/transfer.js"),require("../../lib/erc721/actions/abis/mint.js"),require("../../lib/erc721/actions/abis/safeTransferFrom.js"),require("../../lib/erc721/actions/abis/setApprovalForAll.js"),require("../../lib/erc721/actions/abis/transferFrom.js"),require("../../lib/erc1155/actions/abis/safeBatchTransferFrom.js"),require("../../lib/erc1155/actions/abis/safeTransferFrom.js"),require("../../index-DNFBYH7-.js"),require("@ethersproject/abstract-signer"),require("@ethersproject/contracts"),require("@ethersproject/transactions"),require("fetch-retry");let S=new o.PrivyProviderRpcError(new o.ProviderRpcError("There was an issue preparing your transaction",y.n.E32603_DEFAULT_INTERNAL_ERROR.eipCode)),E=(e,r)=>e?.sendTransaction?"transactionRequest"in e.sendTransaction?e.sendTransaction.transactionRequest:e.sendTransaction.transactionRequests[r]:void 0;exports.SendTransactionScreen=()=>{let v,{data:C,onUserCloseViaDialogOrKeybindRef:w,setModalData:x,navigate:k}=a.usePrivyModal(),{rpcConfig:A,chains:P,closePrivyModal:R,walletProxy:F}=t.usePrivyInternal(),{getAccessToken:D,user:O}=c.usePrivyContext(),L=i.useAppConfig(),[M,N]=r.useState(0),W=(Y=C,Y?.sendTransaction?"transactionRequest"in Y.sendTransaction?0:Y.sendTransaction.transactionRequests.length-1:0),[V,G]=r.useState(E(C,M)),[_,B]=r.useState(null),[H,U]=r.useState(),[z,J]=r.useState(!1),[Q,X]=r.useState(null),[$,K]=r.useState(null);var Y;if(!V||!C?.sendTransaction||!C?.sendTransaction.transactingWallet)/*#__PURE__*/return e.jsx(m.ErrorScreenView,{error:Error("Invalid transaction request"),onClick:()=>{C?.sendTransaction?.onFailure(S),R({shouldCallAuthOnSuccess:!1})}});let{entropyId:Z,entropyIdVerifier:ee,transactingWallet:re}=C.sendTransaction,ne=r.useMemo((()=>P.find((e=>Number(e.id)===Number(V.chainId)))),[V.chainId]),ie=ne?.nativeCurrency.symbol??"ETH",oe=r.useMemo((()=>T.getStaticTransactionMetadata(V.data,!!L.embeddedWallets.extendedCalldataDecoding)),[V.data]),{action:se,isErc20Ish:te,isNFTIsh:ae}=oe;r.useEffect((()=>{V.to&&ne&&te&&l.getErc20TokenInfo({address:V.to,chain:ne,rpcConfig:L.rpcConfig,privyAppId:L.id}).then(B).catch(console.error)}),[V.to,ne]);let{tokenPrice:ce,isTokenPriceLoading:ue}=u.useGetTokenPrice(V.chainId),le=r.useMemo((()=>q.getJsonRpcProvider(Number(V.chainId),P,A,{appId:L.id})),[V.chainId,A]),de=b.usePrepareTransaction(V,re,le);r.useEffect((()=>{G(E(C,M))}),[M]),r.useEffect((()=>{C.sendTransaction?.getIsSponsored?C.sendTransaction.getIsSponsored().then(U).catch(console.error):U(!1)}),[C.sendTransaction.getIsSponsored]);let pe=()=>{if(!z)return Q?C?.sendTransaction?.onSuccess(Q.response):$||de?.errors[0]?C?.sendTransaction?.onFailure($??de?.errors[0]??S):C?.sendTransaction?.onFailure(new o.PrivyProviderRpcError(new o.ProviderRpcError("The user rejected the request",y.n.E4001_USER_REJECTED_REQUEST.eipCode))),R({shouldCallAuthOnSuccess:!1})};w.current=pe;let qe=!!(C.funding&&C.funding.supportedOptions.length>0),me="fiat-currency"===L.embeddedWallets.priceDisplay.primary,je=I.i(de?.tx.value??0).add(I.i(de?.totalGasEstimate?.toBigInt()??0)).toHexString(),he=p.getNativeCurrencyFromWei(je,ie),ge=me&&ce?p.getDollarsFromWei(je,ce):void 0,fe=p.getNativeCurrencyFromWei(de?.totalGasEstimate?.toString()??0,ie),Te=me&&ce?p.getDollarsFromWei(de?.totalGasEstimate?.toString()??0,ce):void 0,be=p.getNativeCurrencyFromWei(de?.balance?.toString()??0,ie,void 0,!0),ye=me&&ce?p.getDollarsFromWei(de?.balance?.toString()??0,ce):void 0,Ie=C.sendTransaction?.uiOptions?.transactionInfo?.title;Ie||(Ie="approve"===se?te?"Confirm address":"Confirm action":`Approve ${se}`);let Se=C.sendTransaction?.uiOptions?.description||`${L.name} wants your permission to approve the following transaction.`,Ee=C.sendTransaction?.uiOptions?.transactionInfo?.contractInfo?.imgUrl?/*#__PURE__*/e.jsx("img",{src:C.sendTransaction.uiOptions.transactionInfo.contractInfo.imgUrl,alt:C.sendTransaction.uiOptions.transactionInfo.contractInfo.imgAltText}):null,ve=!(!de||de.errors[0]||de.hasFunds||!1!==H),Ce=ve&&qe,we=Ce?"Add funds":C.sendTransaction?.uiOptions?.buttonText||(M<W?"Continue":"Approve");if(Q?.receipt)/*#__PURE__*/return e.jsx(f.TransactionReceiptView,{txn:de?.tx??V,onClose:pe,receipt:Q.receipt,transactionInfo:C.sendTransaction?.uiOptions.transactionInfo,tokenPrice:ce,tokenSymbol:ie,l1GasEstimate:de?.l1ExecutionFeeEstimate?.toString(),receiptHeader:C.sendTransaction?.uiOptions.successHeader,receiptDescription:C.sendTransaction?.uiOptions.successDescription});if($)/*#__PURE__*/return e.jsx(g.TransactionErrorView,{transactionError:$,network:"ethereum",chainId:de?.tx.chainId??V.chainId,onClose:pe,onRetry:({resetNonce:e})=>{K(null);let r={...de?.tx??V};e&&(r.nonce=void 0),G(r)}});let xe=0!==W&&"number"==typeof M&&0!==M?()=>{N(M-1)}:void 0;return"amount"in oe&&oe.amount&&(oe.isNFTIsh?v=oe.amount.toString():_&&(v=d.formatErc20TokenAmount({amount:oe.amount,decimals:_.decimals}))),/*#__PURE__*/e.jsx(h.SendTransactionScreenView,{transactionIndex:M,onBack:xe,maxIndex:W,disabled:ve&&!qe,isSubmitting:z,submitError:$,isPreparing:!de,isTokenPriceLoading:ue,isTokenContractInfoLoading:!ae&&!_,prepareError:de?.errors[0],symbol:_?.symbol,chain:ne,img:Ee,title:Ie,subtitle:Se,total:V.value?ge??he:void 0,txValue:V.value,fee:Te??fe,isSponsored:H,from:re?.address??"",to:V.to,network:L.chains.find((e=>e.id===V.chainId))?.name??"",transactionDetails:{...oe,formattedAmount:v},cta:we,missingFunds:ve,action:se,balance:ye??be,onClose:pe,onClick:Ce?async()=>{if(!re)return;if(!qe)throw Error("Funding wallet is not enabled");let e=j.ModalScreen.FUNDING_METHOD_SELECTION_SCREEN;x({...C,funding:{...C.funding,methodScreen:e,chainType:"ethereum",amount:n.formatEther(BigInt(de?.tx.value??0)+BigInt(de?.totalGasEstimate?.toString()??0)),chain:ne}}),k(e)}:async()=>{if(M<W)N(M+1);else{J(!0);try{let e=await D();if(z||!e||!re||!F||!O)return;let r=C?.sendTransaction?.onConfirm?await C.sendTransaction.onConfirm().then((e=>le.getTransaction(e))):await s.sendTransaction({accessToken:e,transactingWallet:re,entropyId:Z,entropyIdVerifier:ee,walletProxy:F,transactionRequest:de?.tx??V,provider:le,requesterAppId:C.sendTransaction?.requesterAppId}),n=await r.wait();X({receipt:s.formatReceipt(n),response:r})}catch(e){console.warn({transaction:de?.tx??V,error:e}),K(e)}finally{J(!1)}}}})};
